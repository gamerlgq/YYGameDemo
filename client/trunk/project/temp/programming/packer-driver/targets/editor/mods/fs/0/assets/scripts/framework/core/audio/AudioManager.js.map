{"version":3,"sources":["file:///Users/steven/Workspaces/CocosCreatorProjects/3D/YYGameDemo/client/trunk/project/assets/scripts/framework/core/audio/AudioManager.ts"],"names":["AudioManager","game","Node","storage","AudioEffect","AudioMusic","LOCAL_STORE_KEY","getInstance","_instance","init","addPersistRootNode","addComponent","music","getComponent","effect","__init","data","get","_localStorageTag","local_data","JSON","parse","_volume_music","volume_music","_volume_effect","volume_effect","_switch_music","switch_music","_switch_effect","switch_effect","e","volume","_musicQueue","Array","setUuid","value","_uuid","playMusic","url","callback","push","_playMusic","popMusic","pop","lastIndex","length","load","onComplete","playEffect","musicVolume","effectVolume","getSwitchMusic","setSwitchMusic","stop","getSwitchEffect","setSwitchEffect","resumeAll","play","pauseAll","pause","stopAll","save","stringify","set","audioMgr"],"mappings":"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","sourcesContent":["import { Component, Game, game, Node } from \"cc\";\r\nimport { storage } from \"../storage/Storage\";\r\nimport { AudioEffect } from \"./AudioEffect\";\r\nimport { AudioMusic } from \"./AudioMusic\";\r\n\r\nconst LOCAL_STORE_KEY = \"game_audio\";\r\n\r\nclass AudioManager extends Node {\r\n    private static _instance: AudioManager = null;\r\n\r\n    private local_data: any = {};\r\n\r\n    private music!: AudioMusic;\r\n    private effect!: AudioEffect;\r\n\r\n    private _volume_music: number = 1;\r\n    private _volume_effect: number = 1;\r\n    private _switch_music: boolean = true;\r\n    private _switch_effect: boolean = true;\r\n    private _uuid: string = \"10000\";                // 玩家唯一标识，一般为玩家数据库唯一编号\r\n    private _localStorageTag: string = \"\";          // 本地存储标签名\r\n\r\n    private _musicQueue:Array<string> = null;\r\n\r\n    public static getInstance(): AudioManager {\r\n        if (!AudioManager._instance ) {\r\n            AudioManager._instance = new AudioManager();\r\n        }\r\n        return AudioManager._instance;\r\n    }\r\n\r\n    /**\r\n     * init\r\n     */\r\n    public init() {\r\n        game.addPersistRootNode(AudioManager._instance);\r\n\r\n        AudioManager._instance.addComponent(AudioMusic);\r\n        this.music = AudioManager._instance.getComponent(AudioMusic);\r\n\r\n        AudioManager._instance.addComponent(AudioEffect);\r\n        this.effect = AudioManager._instance.getComponent(AudioEffect);\r\n\r\n        AudioManager._instance.__init();\r\n    }\r\n\r\n    private __init() {\r\n        let data = storage.get(this._localStorageTag);\r\n        if (data) {\r\n            try {\r\n                this.local_data = JSON.parse(data);\r\n                this._volume_music = this.local_data.volume_music;\r\n                this._volume_effect = this.local_data.volume_effect;\r\n                this._switch_music = this.local_data.switch_music;\r\n                this._switch_effect = this.local_data.switch_effect;\r\n            }\r\n            catch (e) {\r\n                this.local_data = {};\r\n                this._volume_music = 1;\r\n                this._volume_effect = 1;\r\n                this._switch_music = true;\r\n                this._switch_effect = true;\r\n            }\r\n\r\n            this.music.volume = this._volume_music;\r\n            this.effect.volume = this._volume_effect;\r\n        }\r\n\r\n        this._musicQueue = new Array();\r\n    }\r\n\r\n    /** 设置玩家唯一标识 */\r\n    public setUuid(value: string) {\r\n        this._uuid = value;\r\n        this._localStorageTag = `${LOCAL_STORE_KEY}_${this._uuid}`;\r\n    }\r\n\r\n    /**\r\n     *  播放背景音乐\r\n     * @param url        资源地址\r\n     * @param callback   音乐播放完成事件\r\n     */\r\n    playMusic(url: string, callback?: Function) {\r\n        this._musicQueue.push(url);\r\n        this._playMusic(url,callback);\r\n    }\r\n\r\n    /**\r\n     * 推出场景需要在onDestory pop一下\r\n     */\r\n    popMusic(){\r\n        this._musicQueue.pop();\r\n        const lastIndex = this._musicQueue.length -1 \r\n        const url = this._musicQueue[lastIndex];\r\n        if (url){\r\n            this._playMusic(url);\r\n        }\r\n    }\r\n\r\n    private _playMusic(url: string, callback?: Function){\r\n        if (this._switch_music) {\r\n            this.music.load(url);\r\n            this.music.onComplete = callback;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 播放音效\r\n     * @param url        资源地址\r\n     */\r\n    playEffect(url: string) {\r\n        if (this._switch_effect) {\r\n            this.effect.load(url);\r\n        }\r\n    }\r\n\r\n    /** 背景音乐音量 */\r\n    public get musicVolume(): number {\r\n        return this._volume_music;\r\n    }\r\n    public set musicVolume(value: number) {\r\n        this._volume_music = value;\r\n        this.music.volume = value;\r\n    }\r\n\r\n    /** 音效音量 */\r\n    public get effectVolume(): number {\r\n        return this._volume_effect;\r\n    }\r\n    public set effectVolume(value: number) {\r\n        this._volume_effect = value;\r\n        this.effect.volume = value;\r\n    }\r\n\r\n    /** 音乐开关 */\r\n    public getSwitchMusic(): boolean {\r\n        return this._switch_music;\r\n    }\r\n    public setSwitchMusic(value: boolean) {\r\n        this._switch_music = value;\r\n\r\n        if (value == false)\r\n            this.music.stop();\r\n    }\r\n\r\n    /** 音效开关 */\r\n    public getSwitchEffect(): boolean {\r\n        return this._switch_effect;\r\n    }\r\n    public setSwitchEffect(value: boolean) {\r\n        this._switch_effect = value;\r\n        if (value == false)\r\n            this.effect.stop();\r\n    }\r\n\r\n    public resumeAll() {\r\n        if (this.music) {\r\n            this.music.play();\r\n            this.effect.play();\r\n        }\r\n    }\r\n\r\n    public pauseAll() {\r\n        if (this.music) {\r\n            this.music.pause();\r\n            this.effect.pause();\r\n        }\r\n    }\r\n\r\n    public stopAll() {\r\n        if (this.music) {\r\n            this.music.stop();\r\n            this.effect.stop();\r\n        }\r\n    }\r\n\r\n    public save() {\r\n        this.local_data.volume_music = this._volume_music;\r\n        this.local_data.volume_effect = this._volume_effect;\r\n        this.local_data.switch_music = this._switch_music;\r\n        this.local_data.switch_effect = this._switch_effect;\r\n\r\n        let data = JSON.stringify(this.local_data);\r\n        storage.set(this._localStorageTag, data);\r\n    }\r\n}\r\n\r\nexport let audioMgr:AudioManager = (()=>{\r\n    return AudioManager.getInstance();\r\n})();"]}