{"version":3,"sources":["file:///Users/steven/Workspaces/CocosCreatorProjects/3D/GameDemoReal/assets/scripts/app/views/fight/fightFormation/FightFormation.ts"],"names":["PosInfo","_decorator","Node","Prefab","instantiate","find","tween","UITransform","v3","sceneMgr","LayerBase","ViewProtocol","GeneralIconShowComp","ccclass","property","FightFormation","Map","start","_init","_showGerneralIconListByType","_initPosInfo","index","posNode","node","posInfo","_posList","push","_upPosMap","set","on","EventType","TOUCH_END","onClickDown","bind","event","target","children","length","get","orgGeneralIcon","removeAllChildren","getComponent","isSel","isShowSelIcon","icon","rewardItemIconPrefab","addComponent","listContainer","addChild","_onUp","generalIconShowComp","upPos","iterator","_playMove","targetNode","endFunc","nodeTween","startPos","convertToWorldSpaceAR","convertToNodeSpaceAR","endPos","position","to","call","onClickStart","sendCreateView","TransLoadingLayer","popTableLayer","FightMainLayer"],"mappings":"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","sourcesContent":["\nimport { _decorator, Component, Node, Prefab, instantiate, find, EventTouch, Tween, tween, UITransform, Vec3, v3, director, AnimationManager } from 'cc';\nimport { sceneMgr } from '../../../../framework/core/SceneMgr';\nimport { LayerBase } from '../../../../framework/ui/LayerBase';\nimport { ViewProtocol } from '../../../define/ViewProtocol';\nimport { GeneralIconShowComp } from './GeneralIconShowComp';\nconst { ccclass, property } = _decorator;\n\nclass PosInfo\n{\n    node:Node;\n    orgGeneralIcon:Node;\n}\n \n@ccclass('FightFormation')\nexport class FightFormation extends LayerBase {\n    @property(Node)\n    listContainer:Node;\n\n    @property(Prefab)\n    rewardItemIconPrefab:Prefab;\n\n    private _posList:PosInfo[] = [];\n    private _upPosMap:Map<Node, PosInfo> = new Map;\n\n    start () {\n        // [3]\n        this._init();\n    }\n\n    private async _init() {\n        // let path = viewRegisterMgr.getViewInfo(\"commonUI\",\"RewardItemIcon\").Path\n        // this._rewardItemIconPrefab = await ResourcesLoader.loadPromise(path)\n\n        this._showGerneralIconListByType()\n        this._initPosInfo()\n    }\n    \n    private _initPosInfo() {\n        for (let index = 0; index < 5; index++) {\n            let posNode = find(\"bottom/pos_\"+(index+1), this.node)\n            let posInfo = new PosInfo\n            posInfo.node = posNode\n            this._posList.push(posInfo)\n            this._upPosMap.set(posNode, posInfo)\n\n            posNode.on(Node.EventType.TOUCH_END, this.onClickDown.bind(this))\n        }\n    }\n\n    private onClickDown(event:EventTouch) {\n        let target = event.target\n        if (target.children.length > 0) {\n            let posInfo = this._upPosMap.get(target)\n            if (posInfo.orgGeneralIcon) {\n                target.removeAllChildren()\n                posInfo.orgGeneralIcon.getComponent(GeneralIconShowComp).isSel = false\n                posInfo.orgGeneralIcon.getComponent(GeneralIconShowComp).isShowSelIcon = false\n                posInfo.orgGeneralIcon = null\n            }\n        }\n    }\n    \n    private _showGerneralIconListByType(){\n        for (let index = 0; index < 20; index++) {\n            let icon = instantiate(this.rewardItemIconPrefab)\n            icon.addComponent(GeneralIconShowComp)\n            this.listContainer.addChild(icon)\n            icon.on(Node.EventType.TOUCH_END, this._onUp.bind(this) )\n        }\n    }\n\n    //上阵\n    private _onUp(event:EventTouch) {\n        let node:Node = event.target\n        let generalIconShowComp = node.getComponent(GeneralIconShowComp)\n\n        if (!generalIconShowComp.isSel) {\n            //寻找上阵位置\n\n            let upPos:PosInfo\n        for (const iterator of this._posList) {\n                if (!iterator.orgGeneralIcon) {\n                    upPos = iterator\n                    break;\n                }\n            }\n            if (upPos) {\n                //可以上阵    \n                generalIconShowComp.isSel = true\n                upPos.orgGeneralIcon = node\n                this._playMove(node, upPos.node,()=>{\n                })\n            }\n        }\n    }\n\n    private _playMove(node:Node, targetNode:Node, endFunc:Function) {\n        //复制一个目标\n        let nodeTween = instantiate(node)\n        let startPos = node.getComponent(UITransform).convertToWorldSpaceAR(v3(0,0,0))\n        startPos = this.node.getComponent(UITransform).convertToNodeSpaceAR(startPos)\n\n        let endPos = targetNode.getComponent(UITransform).convertToWorldSpaceAR(v3(0,0,0))\n        endPos = this.node.getComponent(UITransform).convertToNodeSpaceAR(endPos)\n\n        this.node.addChild(nodeTween)\n        nodeTween.position = startPos\n        tween(nodeTween).to(0.5,{position:endPos}).call(()=>{\n            node.getComponent(GeneralIconShowComp).isShowSelIcon = true\n            nodeTween.position=v3(0,0,0)\n            targetNode.addChild(nodeTween)\n            endFunc()\n        }).start()\n    }\n    \n\n    onClickStart() {\n        sceneMgr.sendCreateView(ViewProtocol.TransLoadingLayer,[()=>{\n            sceneMgr.popTableLayer();\n            sceneMgr.sendCreateView(ViewProtocol.FightMainLayer);\n        },()=>{}]);\n    }\n}"]}