{"version":3,"sources":["file:///Users/steven/Workspaces/CocosCreatorProjects/3D/YYGameDemo/client/trunk/project/assets/scripts/framework/core/audio/AudioMusic.ts"],"names":["AudioClip","AudioSource","Tween","_decorator","ResourcesLoader","audioMgr","ccclass","menu","AudioMusic","progress","_progress","currentTime","duration","value","load","url","isLoop","callback","data","_fadeOut","clip","play","loop","_url","_fadeIn","onFin","playing","_tweenVo","stop","to","volume","onComplete","tar","release","start","musicVolume","update","dt","_isPlay"],"mappings":"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","sourcesContent":["import { AudioClip, AudioSource, error, log, Tween, tween, _decorator } from 'cc';\r\nimport { ResourcesLoader } from '../../data/ResourcesLoader';\r\nimport { audioMgr } from './AudioManager';\r\nconst { ccclass, menu } = _decorator;\r\n\r\n/** 背景音乐 */\r\n@ccclass('AudioMusic')\r\nexport class AudioMusic extends AudioSource {\r\n    public onComplete: Function | null = null;\r\n    private _progress: number = 0;\r\n    private _url: string | null = null;\r\n    private _isPlay: boolean = false;\r\n\r\n    private _tweenVo;\r\n\r\n    /**\r\n     * 设置音乐当前播放进度\r\n     * @param progress 进度百分比(0~1)\r\n     */\r\n    public get progress() {\r\n        this._progress = this.currentTime / this.duration;\r\n        return this._progress;\r\n    }\r\n    public set progress(value: number) {\r\n        this._progress = value;\r\n        this.currentTime = value * this.duration;\r\n    }\r\n\r\n    public load(url: string,isLoop:boolean=true, callback?: Function) {\r\n        ResourcesLoader.load(url, (data:AudioClip)=>{\r\n            this._fadeOut(()=>{\r\n                this.clip = data;\r\n                this.currentTime = 0;\r\n                this.play();\r\n                this.loop = isLoop;\r\n                callback && callback();\r\n                this._url = url;\r\n\r\n                this._fadeIn()\r\n            })\r\n        },AudioClip)\r\n    }\r\n\r\n    private _fadeOut(onFin:Function) {\r\n        if (this.playing) {\r\n            this._tweenVo?.stop();\r\n            this._tweenVo = new Tween(this);\r\n            this._tweenVo.to(1, {volume:0}, {onComplete:(tar)=>{\r\n                this._tweenVo = null\r\n                this.stop()\r\n                ResourcesLoader.release(this._url!);\r\n                onFin()\r\n            }}).start()\r\n        }\r\n        else {\r\n            onFin()\r\n        }\r\n    }\r\n\r\n    private _fadeIn() {\r\n        this._tweenVo?.stop();\r\n        this._tweenVo = new Tween(this);\r\n        this.volume = 0;\r\n        this._tweenVo.to(1, {volume:audioMgr.musicVolume}, {onComplete:()=>{this._tweenVo=null}}).start()\r\n    }\r\n\r\n    update(dt: number) {\r\n        if (this.currentTime > 0) {\r\n            this._isPlay = true;\r\n        }\r\n\r\n        if (this._isPlay && this.playing == false) {\r\n            this._isPlay = false;\r\n            this.onComplete && this.onComplete();\r\n        }\r\n    }\r\n\r\n    release() {\r\n        if (this._url) {\r\n            ResourcesLoader.release(this._url);\r\n            this._url = null;\r\n        }\r\n    }\r\n}\r\n"]}