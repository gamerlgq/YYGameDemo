{"version":3,"sources":["file:///Users/steven/Workspaces/CocosCreatorProjects/3D/GameDemoReal/assets/scripts/app/views/fight/FightController.ts"],"names":["FightController","Animation","Singleton","gameMgr","CameraLock","FightData","fightDataMgr","FightEvent","fightEventMgr","FightConstant","fightController","init","getInstance","_init","_initListeners","_initData","addEventListener","Game_Star","_onGameStart","bind","Action_End","_onActionEnd","Game_Replay","_onReplay","Game_Pause","_onPause","Game_Resume","_onResume","_round","_action","_isPause","_fightData","getFightData","data","getRoundData","_roundData","_playCameraAnimation","fightCamera","getCamera","animation","node","getComponent","scriptCom","setEndCallback","_cameraAniEndCallback","play","_roundStart","_actionStart","send","_isGameEnd","_gameEnd","_nextRound","Round","Round_Start","_isRoundFinished","_roundEnd","_nextAction","action","Action","ActionData","Action_Star","length","Game_End","destory","destoryInstance","clear"],"mappings":"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","sourcesContent":["/*\n * @Author: liuguoqing\n * @Date: 2022-03-19 11:17:19\n * @LastEditors: liuguoqing\n * @LastEditTime: 2022-03-20 22:57:06\n * @Description: file content\n */\nimport { Animation, AnimationClip, find, log } from \"cc\";\nimport { Singleton } from \"../../../framework/components/Singleton\";\nimport { gameMgr } from \"../../../framework/core/GameMgr\";\nimport { CameraLock } from \"../../common/animation/CameraLock\";\nimport { FightData } from \"./data/FightData\";\nimport { fightDataMgr } from \"./data/FightDataMgr\";\nimport { FightEvent } from \"./event/FightEvent\";\nimport { FightEventDataType } from \"./event/FightEventDataType\";\nimport { fightEventMgr } from \"./event/FightEventMgr\";\nimport { FightConstant } from \"./FightConstant\";\n\nexport let fightController:FightController = null;\n/**\n * @description 回合控制器 \n * */\nexport class FightController extends Singleton{\n\n    // 当前大回合\n    private _round:number=0;\n    // 当前行动(每回合有多个)\n    private _action:number=0;\n    // fight data\n    private _fightData:FightData;\n    // cur round data\n    private _roundData:Array<Array<any>>;\n    // 是否暂停\n    private _isPause:boolean=false;\n\n    public static init(){\n        fightController = FightController.getInstance<FightController>();\n        fightController._init();\n    }\n\n    private _init(){\n        this._initListeners();\n        this._initData();\n    }\n\n    private _initListeners() {\n        fightEventMgr.addEventListener(FightConstant.FightEvent.Game_Star,this._onGameStart.bind(this));\n        fightEventMgr.addEventListener(FightConstant.FightEvent.Action_End,this._onActionEnd.bind(this));\n        fightEventMgr.addEventListener(FightConstant.FightEvent.Game_Replay,this._onReplay.bind(this));\n        fightEventMgr.addEventListener(FightConstant.FightEvent.Game_Pause,this._onPause.bind(this));\n        fightEventMgr.addEventListener(FightConstant.FightEvent.Game_Resume,this._onResume.bind(this));\n    }\n\n    private _initData(){\n\n        this._round = 0 ;\n        this._action = 0\n        this._isPause = false;\n\n        this._fightData = fightDataMgr.getFightData(FightData);\n        let data = this._fightData.getRoundData();\n        this._roundData = data[this._round];\n    }\n\n    // 游戏开始\n    private _onGameStart(){\n        this._playCameraAnimation();\n    }\n\n    private _playCameraAnimation() {\n        let fightCamera = gameMgr.getCamera(\"MainCamera\");\n        let animation = fightCamera?.node?.getComponent(Animation);\n        let scriptCom = fightCamera?.node?.getComponent(CameraLock);\n        scriptCom?.setEndCallback(this._cameraAniEndCallback.bind(this));\n        animation.play(\"CameraLock\");\n    }\n\n    private _cameraAniEndCallback() {\n        this._roundStart();   \n    }\n\n    // 每回合小行动结束\n    private _onActionEnd() {\n        this._action += 1;\n        this._actionStart();\n    }\n\n    // 重播\n    private _onReplay(){\n        this._initData();\n        fightEventMgr?.send(new FightEvent(FightConstant.FightEvent.Game_Star,null));\n    }\n\n    // 暂停\n    private _onPause(){\n        this._isPause = true;\n    }\n\n    // 恢复\n    private _onResume(){\n        this._isPause = false;\n    }\n\n    // 大回合开始\n    private _roundStart() {\n        let data = this._fightData.getRoundData();\n        this._roundData = data[this._round];\n        this._round += 1;//回合数+1\n        this._action = 0;//每回合归零\n        if (this._isGameEnd()){\n            return this._gameEnd();\n        }\n        this._nextRound();\n    }\n\n    private _nextRound(){\n        let data:FightEventDataType.Round_Start = {\n            Round: this._round\n        }\n        fightEventMgr?.send(new FightEvent(FightConstant.FightEvent.Round_Start,data));\n        this._actionStart()\n    }\n\n    // 每回合小行动开始\n    private _actionStart() {\n        if (this._isRoundFinished()){\n            return this._roundEnd();\n        }\n        this._nextAction();\n    }\n\n    private _nextAction() {\n        let action = this._roundData[this._action];\n        let data:FightEventDataType.Action_Start = {\n            Action: this._action,\n            ActionData: action\n        }\n        fightEventMgr?.send(new FightEvent(FightConstant.FightEvent.Action_Star,data));\n    }\n\n    // 是否大回合结束\n    private _isRoundFinished():boolean {\n        return this._action >= this._roundData.length\n    }\n\n    // 大回合结束\n    private _roundEnd() {\n        this._roundStart();\n    }\n\n    // 是否战斗结束\n    private _isGameEnd(){\n        let data = this._fightData.getRoundData();\n        return this._round > data.length;\n    }\n\n    // 战斗结束\n    private _gameEnd() {\n        fightEventMgr?.send(new FightEvent(FightConstant.FightEvent.Game_End,null));\n    }\n\n    public destory(){\n        FightController.destoryInstance();\n    }\n\n    public clear(){\n        fightController = null;\n    }\n    \n}"]}