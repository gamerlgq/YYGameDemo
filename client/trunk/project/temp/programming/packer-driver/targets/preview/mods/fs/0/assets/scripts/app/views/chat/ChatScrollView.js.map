{"version":3,"sources":["file:///Users/steven/Workspaces/CocosCreatorProjects/3D/YYGameDemo/client/trunk/project/assets/scripts/app/views/chat/ChatScrollView.ts"],"names":["_decorator","Component","ScrollView","log","Prefab","UITransform","ChatMsgItemNode","ccclass","property","requireComponent","itemIndex","Set","ChatScrollView","Map","onLoad","scrollView","getComponent","visibleHeight","height","start","index","addChatMsg","scrollToTop","name","text","idx","msgNode","ChatItemPrefab","setData","_itemList","push","content","addChild","lateUpdate","y","Math","floor","getScrollOffset","lastY","getVisibleItemIndex","visibleNodes","forEach","node","has","unuse","delete","reuse","set","clear","curH","element","k","itemH","add","onDestory","chatMsgNodePool"],"mappings":"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","sourcesContent":["\nimport { _decorator, Component, Node, ScrollView, log, Prefab, UITransform, math } from 'cc';\nimport { ChatMsgItemNode } from './ChatMsgItemNode';\nconst { ccclass, property, requireComponent } = _decorator;\n\n/**\n * Predefined variables\n * Name = ChatLayer\n * DateTime = Thu Mar 17 2022 14:13:20 GMT+0800 (中国标准时间)\n * Author = maikx123456\n * FileBasename = ChatLayer.ts\n * FileBasenameNoExtension = ChatLayer\n * URL = db://assets/scripts/app/views/common/ui/ChatLayer.ts\n * ManualUrl = https://docs.cocos.com/creator/3.4/manual/zh/\n *\n */\n\nconst itemIndex = new Set<number>();\n\n@ccclass('ChatScrollView')\nexport class ChatScrollView extends Component {\n\n    @property spaceY = 0;\n    @property(Prefab) ChatItemPrefab: Prefab\n\n    scrollView: ScrollView;\n    private visibleHeight: number;\n    private _itemList: ChatMsgItemNode[] = []\n    private visibleNodes = new Map<number, ChatMsgItemNode>();\n    private lastY;\n\n    onLoad() {\n        this.scrollView = this.getComponent(ScrollView);\n        this.visibleHeight = this.scrollView.getComponent(UITransform).height\n\n      \n    }\n\n    start() {\n        for (let index = 0; index < 100; index++) {\n            if (index % 2 == 0) {\n                this.addChatMsg(\"玩家1：\", \"<color=#00ff00>Rich</color>\", index)\n            }\n            else{\n                this.addChatMsg(\"玩家2：\", \"撒大声地撒大所奥术大师多奥术大师多大时代实打实撒大声地撒大所奥术大师多奥术大师多大时代实打实\", index)\n            }\n        }\n\n        this.scrollView.scrollToTop()\n    }\n\n    addChatMsg(name: string, text: string, idx: number) {\n        let msgNode = new ChatMsgItemNode(this.ChatItemPrefab)\n        msgNode.setData(idx, name, text)\n        this._itemList.push(msgNode)\n        this.scrollView.content.addChild(msgNode)\n    }\n\n    lateUpdate() {\n        const y = Math.floor(this.scrollView.getScrollOffset().y);\n        if (this.lastY == y) {\n            return\n        }\n        this.lastY = y;\n\n        //更新可见item索引\n        this.getVisibleItemIndex(y)\n        this.visibleNodes.forEach((node, idx) => {\n            if (!itemIndex.has(idx)) {\n                node.unuse()\n                this.visibleNodes.delete(idx);\n                // console.log(\"丢弃:\",idx );\n            }\n        });\n        itemIndex.forEach((idx) => {\n            if (!this.visibleNodes.has(idx)) {\n                let msgNode = this._itemList[idx]\n                msgNode.reuse()\n                this.visibleNodes.set(idx, msgNode);\n            }\n        });\n    }\n\n    getVisibleItemIndex(y: number) {\n        itemIndex.clear();\n\n        let curH = 0;\n        this._itemList.forEach((element, k) => {\n            let itemH = element.getComponent(UITransform).height\n            curH += itemH\n\n            if (curH > y && (curH - itemH) < y + this.visibleHeight) {\n                itemIndex.add(k);\n            }\n        });\n    }\n\n    onDestory(){\n        log(\"ChatScrollView clear\")\n        ChatMsgItemNode.chatMsgNodePool.clear()\n    }\n\n    // update (deltaTime: number) {\n    //     // [4]\n    // }\n}\n\n/**\n * [1] Class member could be defined like this.\n * [2] Use `property` decorator if your want the member to be serializable.\n * [3] Your initialization goes here.\n * [4] Your update function goes here.\n *\n * Learn more about scripting: https://docs.cocos.com/creator/3.4/manual/zh/scripting/\n * Learn more about CCClass: https://docs.cocos.com/creator/3.4/manual/zh/scripting/decorator.html\n * Learn more about life-cycle callbacks: https://docs.cocos.com/creator/3.4/manual/zh/scripting/life-cycle-callbacks.html\n */\n"]}