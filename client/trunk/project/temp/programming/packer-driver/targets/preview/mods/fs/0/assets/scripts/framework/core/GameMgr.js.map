{"version":3,"sources":["file:///Users/steven/Workspaces/CocosCreatorProjects/3D/YYGameDemo/client/trunk/project/assets/scripts/framework/core/GameMgr.ts"],"names":["GameMgr","director","Game","game","log","Scheduler","sys","Singleton","modelEventMgr","msgEventMgr","sceneMgr","constructor","_cameraMap","Map","_modelMapName","_slowTickList","_fastTickList","_innerMessageQueue","_serverMessageQueue","s","getScheduler","enableForTarget","schedule","dt","_slowTick","_fastTick","on","EVENT_SHOW","_enterForeground","bind","EVENT_HIDE","_enterBackground","setApp","app","_app","addNetMessage","msg","push","addInnerMessage","addSlowTick","func","registerModel","modelConstructor","set","name","getModel","get","setCamera","key","camera","getCamera","reRun","removeAllTableLayer","setSystemOpenLayer","setNewGuideLayer","loadScene","getDeviceInfo","refresh","_deviceInfo","info","DeviceModel","IMEI","NetWork","SystemVer","infoStr","isNative","os","OS","IOS","ANDROID","jsb","reflection","callStaticMethod","keys","infoArray","split","index","length","element","console","_curTimeoutID","clearTimeout","setTimeout","window","trackLogoutEvent","forEach","hdl","innerlenght","msgEvent","shift","_dispatchMsgEvent","serverlenght","dispatchEvent","clear","gameMgr","getInstance"],"mappings":"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","sourcesContent":["import { Camera, director, Game, game, ISchedulable, log, Scheduler, sys } from \"cc\";\nimport { DeviceInfoType } from \"../../app/define/ConfigType\";\nimport { yy } from \"../../app/define/YYNamespace\";\nimport { EnterApp } from \"../../app/EnterApp\";\nimport { Singleton } from \"../components/Singleton\";\nimport { ModelBase } from \"../data/ModelBase\";\nimport { modelEventMgr, msgEventMgr } from \"../listener/EventMgr\";\nimport { Message } from \"../listener/Message\";\nimport { sceneMgr } from \"./SceneMgr\";\n\n/*\n * @Author: liuguoqing\n * @Date: 2022-03-02 17:58:23\n * @LastEditors: liuguoqing\n * @LastEditTime: 2022-03-03 15:34:23\n * @Description: file content\n */\ntype tickFunc = (hdl: number) => void;\n\nexport class GameMgr extends Singleton implements ISchedulable {\n    // ISchedulable\n    id?: string;\n    uuid?: string;\n    private _modelMapName: Map<string, any>;\n\n    private _slowTickList: Array<tickFunc>;\n    private _fastTickList: Array<tickFunc>;\n\n    private _cameraMap: Map<string, Camera>;\n\n    private _serverMessageQueue: Array<Message>; // 服务端消息队列\n    private _innerMessageQueue: Array<Message>; // 内部消息队列\n\n    private _app: EnterApp;\n    private _deviceInfo:DeviceInfoType;\n\n    //进入后台时间计时器ID\n    private _curTimeoutID: any; \n\n    // 构造函数\n    private constructor() {\n        super();\n        // camera\n        this._cameraMap = new Map();\n\n        // model\n        this._modelMapName = new Map();\n\n        // event tick\n        this._slowTickList = [];\n        this._fastTickList = [];\n\n        // message queue\n        this._innerMessageQueue = [];\n        this._serverMessageQueue = [];\n\n        // scheduler\n        let s = director.getScheduler();\n        Scheduler.enableForTarget(this);\n\n        // slow tick\n        s.schedule((dt) => {\n                this._slowTick(dt);\n            },\n        this,1);\n\n        // quick tick\n        s.schedule((dt) => {\n            this._fastTick(dt);\n        },\n        this,0);\n\n        // game on foreground\n        game.on(Game.EVENT_SHOW, this._enterForeground.bind(this), this);\n\n        // game on background\n        game.on(Game.EVENT_HIDE, this._enterBackground.bind(this), this);\n    }\n\n    public setApp(app: EnterApp) {\n        this._app = app;\n    }\n\n    public addNetMessage(msg: Message) {\n        this._serverMessageQueue.push(msg);\n    }\n\n    public addInnerMessage(msg: Message) {\n        this._innerMessageQueue.push(msg);\n    }\n\n    public addSlowTick(func: tickFunc) {\n        this._slowTickList.push(func);\n    }\n\n    /**\n     * 把消息id绑定指定的model\n     */\n    public registerModel<T extends ModelBase>( modelConstructor: yy.types.CommonConstructor<T>)\n    {\n        this._modelMapName.set(modelConstructor.name, new modelConstructor());\n    }\n\n    /**\n     * 获取model\n     */\n    public getModel<T extends ModelBase>(modelConstructor: yy.types.CommonConstructor<T>): T {\n        return this._modelMapName.get(modelConstructor.name);\n    }\n\n    /**\n     * 获取摄像机\n     */\n    public setCamera(key: string, camera: Camera) {\n        this._cameraMap.set(key, camera);\n    }\n\n    /**\n     * 获取摄像机\n     */\n    public getCamera(key: string) {\n        return this._cameraMap.get(key);\n    }\n\n    public reRun() {\n        log(\"GameMgr reRunRun0\");\n        sceneMgr.removeAllTableLayer();\n        sceneMgr.setSystemOpenLayer(null);\n        sceneMgr.setNewGuideLayer(null);\n        if (this._app) {\n            log(\"GameMgr reRunRun1\");\n            this._app.reRun();\n        } else {\n            log(\"GameMgr reRunRun2\");\n            director.loadScene(\"HotUpdate\");\n        }\n    }\n\n    public getDeviceInfo( refresh?:boolean): DeviceInfoType {\n        if (this._deviceInfo && !refresh) {\n            return this._deviceInfo;\n        }\n        let info = {\n            DeviceModel: \"\",\n            IMEI: \"\",\n            NetWork: \"\",\n            SystemVer: \"\",\n        };\n        let infoStr: string;\n        if (sys.isNative) {\n            if (sys.os == sys.OS.IOS) {\n                // infoStr = jsb.reflection.callStaticMethod(\"MyOcHelper\", \"get_device_info\");\n            } else if (sys.os == sys.OS.ANDROID) {\n                // todo\n                infoStr = jsb.reflection.callStaticMethod(\n                    \"com/youai/lib/Helper\",\n                    \"getDeviceInfo\",\n                    \"()Ljava/lang/String;\"\n                );\n            }\n        }\n        if (infoStr) {\n            let keys = [\"DeviceModel\", \"IMEI\", \"NetWork\", \"SystemVer\"];\n            let infoArray = infoStr.split(\"|\");\n            if (infoArray) {\n                for (let index = 0; index < infoArray.length; index++) {\n                    const element = infoArray[index];\n                    info[keys[index]] = element;\n                }\n            }\n        }\n        this._deviceInfo = info;\n        return info;\n    }\n\n    private _enterForeground() {\n        console.log(\"游戏进入前台\");\n        // NotifyHelper.getInstance().gameEnterForeground();\n        if (this._curTimeoutID) {\n            clearTimeout(this._curTimeoutID);\n        }\n    }\n\n    private _enterBackground() {\n        console.log(\"游戏进入后台\");\n        // NotifyHelper.getInstance().gameEnterBackground();\n        //5分钟后埋点登出\n        this._curTimeoutID = setTimeout(() => {\n            if (window[\"SDKHelper\"]) {\n                window[\"SDKHelper\"].trackLogoutEvent();\n            }\n        }, 3000);\n    }\n\n    // 慢tick\n    private _slowTick(dt) {\n        this._slowTickList.forEach((hdl) => {\n            hdl(dt);\n        });\n    }\n\n    // 快tick\n    private _fastTick(dt) {\n        // handler inner msg\n        let innerlenght = this._innerMessageQueue.length;\n        while (innerlenght > 0) {\n            let msgEvent = this._innerMessageQueue.shift();\n            this._dispatchMsgEvent(msgEvent);\n            innerlenght = this._innerMessageQueue.length;\n        }\n\n        // handler server msg\n        let serverlenght = this._serverMessageQueue.length;\n        while (serverlenght > 0) {\n            let msgEvent = this._serverMessageQueue.shift();\n            this._dispatchMsgEvent(msgEvent);\n            serverlenght = this._serverMessageQueue.length;\n        }\n\n        this._fastTickList.forEach((hdl) => {\n            hdl(dt);\n        });\n    }\n\n\n    private _dispatchMsgEvent(msg: Message) {\n        // model msg\n        modelEventMgr.dispatchEvent(msg);\n        // view msg\n        msgEventMgr.dispatchEvent(msg);\n        // redGuide msg\n        // SFRedGuideMgr.dispatchEvent(msg);\n    }\n\n    clear(){\n        gameMgr = null;\n    }\n}\n\n// ()();\nexport let gameMgr = (()=>{\n    return GameMgr.getInstance<GameMgr>();\n})();"]}