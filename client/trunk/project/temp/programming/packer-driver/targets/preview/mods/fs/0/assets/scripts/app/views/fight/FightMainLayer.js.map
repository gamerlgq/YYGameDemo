{"version":3,"sources":["file:///Users/steven/Workspaces/CocosCreatorProjects/3D/GameDemoReal/assets/scripts/app/views/fight/FightMainLayer.ts"],"names":["_decorator","instantiate","director","TweenSystem","AnimationManager","audioMgr","ResourcesLoader","LayerBase","Protocol","viewRegisterMgr","fightActionMgr","FightActionMgr","FightData","fightDataMgr","FightDataMgr","fightEventMgr","FightEventMgr","fightBloodMgr","FightBloodMgr","FightConstant","fightController","FightController","FightMainWorld","fightPlayer","FightPlayer","ccclass","property","FightMainLayer","onLoad","_rootNode","node","parent","_content","getChildByName","init","report","_initManagers","_initBg","_loadMainWorld","_loadMainUI","_playBgMusic","_addListeners","parse","_fightMainWorld","addChild","viewInfo","Open_Fight_Editor","getViewInfo","loadWithViewInfo","data","uiNode","_fightMainUI","getComponentInChildren","playMusic","addEventListener","FightEvent","Game_Star","_startGame","bind","addMsgListener","Inner","SetAnimationSpeed","_setSpeed","event","startGame","getFightMainWorld","update","dt","tick","_gameSpeed","getSystem","ID","onDestroy","destory","popMusic","getRawData"],"mappings":"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","sourcesContent":["/*\n * @Author: liuguoqing\n * @Date: 2022-03-19 11:17:19\n * @LastEditors: liuguoqing\n * @LastEditTime: 2022-03-20 23:02:10\n * @Description: file content\n */\n\nimport { _decorator, Prefab, instantiate, Node, js, sys, JsonAsset, log, director, TweenSystem, AnimationManager } from 'cc';\nimport { audioMgr } from '../../../framework/core/audio/AudioManager';\nimport { ResourcesLoader } from '../../../framework/data/ResourcesLoader';\nimport { Message } from '../../../framework/listener/Message';\nimport { LayerBase } from '../../../framework/ui/LayerBase';\nimport { Protocol } from '../../define/define';\nimport { viewRegisterMgr } from '../../define/ViewRegisterMgr';\nimport { fightActionMgr, FightActionMgr } from './action/FightActionMgr';\nimport { FightData } from './data/FightData';\nimport { fightDataMgr, FightDataMgr } from './data/FightDataMgr';\nimport { FightEvent } from './event/FightEvent';\nimport { fightEventMgr,FightEventMgr } from './event/FightEventMgr';\nimport { fightBloodMgr, FightBloodMgr } from './FightBloodMgr';\nimport { FightConstant } from './FightConstant';\nimport { fightController,FightController } from './FightController';\nimport { FightMainUI } from './FightMainUI';\nimport { FightMainWorld } from './FightMainWorld';\nimport { fightPlayer, FightPlayer } from './FightPlayer';\nconst { ccclass, property } = _decorator;\n \n@ccclass('FightMainLayer')\nexport class FightMainLayer extends LayerBase {\n    \n    private _fightMainWorld:FightMainWorld = null;\n    private _fightMainUI:FightMainUI = null;\n    private _content:Node = null;\n    private _rootNode:Node = null;\n    private _gameSpeed:number = 1;\n\n    onLoad () {\n        super.onLoad();\n        this._rootNode = this.node.parent;\n        this._content = this._rootNode.getChildByName(\"content\");\n    }\n\n    /**\n     * @description 初始化\n     */\n    public init(report:JsonAsset) {\n        this._initManagers(report);\n        this._initBg();\n        this._loadMainWorld();\n        this._loadMainUI();\n        this._playBgMusic();\n        this._addListeners();\n    }\n\n    private _initManagers(report:JsonAsset) {\n        // 战报数据管理器\n        FightDataMgr.init();\n        fightDataMgr.parse(report,FightData);\n        // 事件派发器\n        FightEventMgr.init();\n        // 回合控制器\n        FightController.init();\n        // 战斗播放器\n        FightPlayer.init();\n        // action管理器\n        FightActionMgr.init(this);\n        // 飘血管理器\n        FightBloodMgr.init(this);\n    }\n\n    private _initBg() {\n        \n    }\n\n    private _loadMainWorld() {\n        this._fightMainWorld = new FightMainWorld();\n        this._fightMainWorld.init();\n        this._content.addChild(this._fightMainWorld);\n    }\n\n    private _loadMainUI() {\n        let viewInfo = null;\n        if (FightConstant.Open_Fight_Editor){\n            viewInfo = viewRegisterMgr.getViewInfo(\"fight\",\"FightEditorUI\");\n        }else{\n            viewInfo = viewRegisterMgr.getViewInfo(\"fight\",\"FightMainUI\");\n        }\n        \n        ResourcesLoader.loadWithViewInfo(viewInfo,(data:Prefab)=>{\n            let uiNode = instantiate(data);\n            this._content.addChild(uiNode);\n            this._fightMainUI = uiNode.getComponentInChildren(\"FightMainUI\") as FightMainUI;\n        })\n    }\n\n    private _playBgMusic() {\n        audioMgr.playMusic(\"fight/avs/zhengzhan_bjyy\");\n    }\n\n    private _addListeners() {\n        fightEventMgr.addEventListener(FightConstant.FightEvent.Game_Star,this._startGame.bind(this));\n        this.addMsgListener(Protocol.Inner.SetAnimationSpeed,this._setSpeed.bind(this));\n    }\n\n    private _startGame(event:FightEvent) {\n        this._fightMainWorld.startGame();\n        this._fightMainUI.startGame();\n    }\n\n    /**\n     * @return FightMainWorld\n     */\n    public getFightMainWorld():FightMainWorld {\n        return this._fightMainWorld;\n    }\n\n    update (dt: number) {\n        this._fightMainWorld?.tick(dt);\n\n        if (this._gameSpeed == 2){\n            director.getSystem(TweenSystem.ID).update(dt);\n            director.getSystem(AnimationManager.ID).update(dt);\n        }\n    }\n\n    onDestroy(){\n        fightController.destory();\n        fightDataMgr.destory();\n        fightPlayer.destory();\n        fightActionMgr.destory();\n        fightBloodMgr.destory();\n        fightEventMgr.destory();\n        audioMgr.popMusic();\n    }\n\n    private _setSpeed(event:Message) {\n        let data = event.getRawData();\n        this._gameSpeed = data;\n    }\n}"]}