{"version":3,"sources":["file:///Users/steven/Workspaces/CocosCreatorProjects/3D/GameDemoReal/assets/scripts/framework/components/CameraControls.ts"],"names":["Animation","Camera","Canvas","Component","find","lerp","Node","UITransform","Vec2","Vec3","view","_decorator","ccclass","property","CameraControls","type","tooltip","visible","smoothFollow","overview","speedZoom","canShake","pointerPan","useBoundaries","onLoad","startFollow","canvas","getComponent","visibleSize","getVisibleSize","initZoomRatio","camera","orthoHeight","locateTarget","node","on","onMouseMove","onTouchMove","pointerPos","jumpZoom","lateUpdate","dt","target","targetPos","parent","convertToWorldSpaceAR","getOverviewTargetsMidpoint","position","xDelta","x","width","yDelta","y","height","pointerXMult","pointerYMult","add","Math","abs","followX","followY","cameraPos","convertToNodeSpaceAR","followRatio","distance","minFollowDist","curSpeed","previousPos","ratio","zoomOutSpeed","zoomInSpeed","minX","maxX","minY","maxY","leftBound","setPosition","bottomBound","rightBound","topBound","midPoint","ZERO","i","overviewTargets","length","overviewMargin","distX","distY","max","shakeCamera","anim","play","scheduleOnce","stopShake","bind","shakeDuration","stop","event","getLocation","centerAtStart"],"mappings":"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","sourcesContent":["/*\n * @Author: liuguoqing\n * @Date: 2021-07-31 18:10:21\n * @LastEditors: liuguoqing\n * @LastEditTime: 2021-08-06 16:50:20\n * @Description: file content\n */\n\nimport { Animation, Camera, Canvas, Component, find, lerp, Node, Size, UITransform, Vec2, Vec3, view, _decorator } from \"cc\";\n\nconst {ccclass, property} = _decorator;\n\n@ccclass(\"CameraControls\")\nexport default class CameraControls extends Component {\n\n    @property({type:Node,tooltip:\"镜头跟随的target\"})\n    target: Node = null;\n\n    @property(Camera)\n    camera: Camera = null;\n\n    @property(Animation)\n    anim:Animation = null;\n\n    @property({tooltip:\"角色跳跃后缩放镜头视野\"})\n    jumpZoom:boolean = false;\n\n    @property({tooltip:\"初始化时，镜头定位到跟随主角\"})\n    centerAtStart:boolean = false;\n\n    @property({tooltip:\"镜头跟随主角移动\"})\n    smoothFollow:boolean = false;\n\n    @property({tooltip:\"x轴：镜头相距主角多少距离才是跟随\",visible(){\n        return this.smoothFollow;\n    }})\n    followX:number = 0;\n\n    @property({tooltip:\"y轴：镜头相距主角多少距离才是跟随\",visible(){\n        return this.smoothFollow;\n    }})\n    followY:number = 0;\n\n    @property({tooltip:\"最小跟随距离，比这个值小就不跟随了\",visible(){\n        return this.smoothFollow;\n    }})\n    minFollowDist:number = 0;\n\n    @property({tooltip:\"差值比率[0~1],跟随平滑度\",visible(){\n        return this.smoothFollow;\n    }})\n    followRatio:number = 0;\n\n    @property({tooltip:\"镜头定位到多个目标的中间位置，总是可以观察到指定的观察目标\"})\n    overview:boolean = false;\n\n    @property({type:[Node],tooltip:\"要overview的目标数组\",visible(){\n        return this.overview;\n    }})\n    overviewTargets:Node[] = [];\n\n    @property({tooltip:\"overview视野的边缘\",visible(){\n        return this.overview;\n    }})\n    overviewMargin:number = 0;\n\n    @property({tooltip:\"镜头随着目标速度变化发生缩放\"})\n    speedZoom:boolean = false;\n\n    @property({tooltip:\"镜头zoom in的速度\",visible () {\n        return this.speedZoom;\n    }})\n    zoomInSpeed:number = 0\n\n    @property({tooltip:\"镜头zoom out的速度\",visible () {\n        return this.speedZoom;\n    }})\n    zoomOutSpeed:number = 0\n    \n    @property({tooltip:\"镜头抖动\"})\n    canShake:boolean= false\n\n    @property({tooltip:\"镜头抖动持续时间\", visible () {\n        return this.canShake;\n    }})\n    shakeDuration:number = 0\n\n    @property({tooltip:\"触摸移动镜头视野\"})\n    pointerPan:boolean = false\n\n    @property({tooltip:\"x轴的距离乘数\",visible () {\n        return this.pointerPan;\n    }})\n    pointerXMult:number = 0 \n\n    @property({tooltip:\"y轴的距离乘数\",visible () {\n        return this.pointerPan;\n    }})\n    pointerYMult:number = 0 \n\n    @property({tooltip:\"视野的范围，超过了这个方位镜头不动\"})\n    useBoundaries:boolean = false\n\n    @property({tooltip:\"top的范围\",visible () {\n        return this.useBoundaries;\n    }})\n    topBound:number=0\n\n    @property({tooltip:\"down的范围\",visible () {\n        return this.useBoundaries;\n    }})\n    bottomBound:number=0\n \n    @property({tooltip:\"left的范围\",visible () {\n        return this.useBoundaries;\n    }})\n    leftBound:number=0\n\n    @property({tooltip:\"right的范围\",visible () {\n        return this.useBoundaries;\n    }})\n    rightBound:number=0\n\n    private startFollow:boolean = null\n    private visibleSize:Size = null\n    private initZoomRatio:number = null\n    private previousPos:Vec3 = null\n    private pointerPos:Vec2 = null\n\n    // LIFE-CYCLE CALLBACKS:\n    onLoad () {\n\n        this.startFollow = false;\n        let canvas = find('Canvas').getComponent(Canvas); \n        this.visibleSize = view.getVisibleSize();\n        this.initZoomRatio = this.camera.orthoHeight;\n        \n        //place camera on target if centerAtStart\n        this.locateTarget();\n\n        if (this.pointerPan) {\n            // this.jumpZoom = false;\n            this.overview = false;\n            this.speedZoom = false;\n            canvas.node.on('mousemove', this.onMouseMove, this);\n            canvas.node.on('touchmove', this.onTouchMove, this);\n            this.pointerPos = null;\n        }\n\n        if (this.overview) {\n            this.jumpZoom = false;\n            this.speedZoom = false;\n        }\n\n        if (this.speedZoom) {\n            this.jumpZoom = false;\n        }\n    }\n\n    lateUpdate(dt){\n        if (!this.target){\n            return;\n        }\n\n        let targetPos:Vec3;\n\n        if (this.overview){\n            targetPos = this.target.parent.getComponent(UITransform).convertToWorldSpaceAR(this.getOverviewTargetsMidpoint());\n        } else {\n            targetPos = this.target.parent.getComponent(UITransform).convertToWorldSpaceAR(this.target.position);\n        }\n\n        if (this.pointerPan && this.pointerPos) {\n            let xDelta = this.pointerPos.x / (this.visibleSize.width/2) - 1;\n            let yDelta = this.pointerPos.y / (this.visibleSize.height/2) - 1;\n            xDelta *= this.pointerXMult;\n            yDelta *= this.pointerYMult;\n            targetPos = targetPos.add(new Vec3(xDelta, yDelta));\n        }\n\n        //smooth follow\n        if (this.smoothFollow) {\n            if (Math.abs(targetPos.x - this.node.position.x) >= this.followX ||\n                Math.abs(targetPos.y - this.node.position.y) >= this.followY) {//when camera and target distance is larger than max distance\n                this.startFollow = true;\n            }\n            if (this.startFollow) {\n                let cameraPos = this.node.parent.getComponent(UITransform).convertToNodeSpaceAR(targetPos);\n                // log(\"===>cameraPos\",cameraPos,targetPos);\n                this.node.position = this.node.position.lerp(cameraPos,this.followRatio);\n                if (Vec2.distance(targetPos, this.node.position) <= this.minFollowDist) {\n                    this.startFollow = false;\n                }\n            }\n        } else {\n            let cameraPos = this.node.parent.getComponent(UITransform).convertToNodeSpaceAR(targetPos);\n            this.node.position = cameraPos;\n        }\n\n        //speed zoom\n        if (this.speedZoom) {\n            let curSpeed = Math.abs(this.previousPos.x - targetPos.x) / dt;\n            let ratio = 0;\n            if (curSpeed > this.zoomOutSpeed) {\n                ratio = 1 - (curSpeed - this.zoomOutSpeed) / (this.zoomInSpeed  - this.zoomOutSpeed);\n                this.camera.orthoHeight = lerp(this.camera.orthoHeight, ratio, 0.02);\n            } else {\n                this.camera.orthoHeight = lerp(this.camera.orthoHeight, this.initZoomRatio, 0.02);\n            }\n        }\n\n        this.previousPos = targetPos;\n        \n        //jump zoom\n        if (this.jumpZoom) {\n            let ratio = targetPos.y / view.getVisibleSize().height;\n            this.camera.orthoHeight = 1 + (0.6 - ratio) * 0.35;\n        }\n\n        //boundaries\n\n        if (this.useBoundaries) {\n            let width = (this.visibleSize.width/2) / this.camera.orthoHeight;\n            let height = (this.visibleSize.height/2) / this.camera.orthoHeight;\n            let minX = this.node.position.x - width;\n            let maxX = this.node.position.x + width;  \n            let minY = this.node.position.y - height;\n            let maxY = this.node.position.y + height;\n            if (minX < this.leftBound) {\n                this.node.setPosition(this.leftBound + width,this.node.position.y);\n            }\n            if (minY < this.bottomBound) {\n                this.node.setPosition(this.node.position.x,this.bottomBound + height);\n            }\n            if (maxX > this.rightBound) {\n                this.node.setPosition(this.rightBound - width,this.node.position.y);\n            }\n            if (maxY > this.topBound) {\n                this.node.setPosition(this.node.position.x,this.topBound - height);\n            }\n        }\n    }\n\n    getOverviewTargetsMidpoint () {\n        let midPoint = Vec3.ZERO;\n        let minX = 99999, minY = 99999, maxX = -99999, maxY = -99999;\n        for (let i = 0; i < this.overviewTargets.length; ++i) {\n            let target = this.overviewTargets[i];\n            maxX = target.position.x > maxX ? target.position.x : maxX;\n            minX = target.position.x < minX ? target.position.x : minX;\n            maxY = target.position.y > maxY ? target.position.y : maxY;\n            minY = target.position.y < minY ? target.position.y : minY;\n        }\n        maxX += this.overviewMargin;\n        minX -= this.overviewMargin;\n        maxY += this.overviewMargin;\n        minY -= this.overviewMargin;\n        let distX = Math.abs(maxX - minX);\n        let distY = Math.abs(maxY - minY);\n        midPoint = new Vec3(minX + distX/2, minY + distY/2);\n        let ratio = Math.max(distX / this.visibleSize.width, distY / this.visibleSize.height);\n        this.camera.orthoHeight = 1/ratio;\n        return midPoint;\n    }\n\n    shakeCamera () {\n        if (!this.canShake) return;\n        this.anim.play('shake');\n        this.scheduleOnce(this.stopShake.bind(this), this.shakeDuration);\n    }\n\n    stopShake () {\n        this.anim.stop();\n        this.camera.node.position = Vec3.ZERO;\n    }\n\n    onMouseMove (event) {\n        this.pointerPos = event.getLocation();\n    }\n\n    onTouchMove (event) {\n        this.pointerPos = event.getLocation();\n    }    \n\n    public locateTarget(){\n        if (!this.target) {\n            return;\n        }\n        if (this.centerAtStart) {\n            let targetPos = this.target.getComponent(UITransform).convertToWorldSpaceAR(Vec3.ZERO);\n            let cameraPos = this.node.parent.getComponent(UITransform).convertToNodeSpaceAR(targetPos);\n            this.node.position = cameraPos;\n        }\n        this.previousPos = this.node.position;\n    }\n}\n"]}